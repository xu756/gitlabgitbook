# 在 Linux 上搭建 GitLab 并集成 GitBook 实现自动化 Wiki 系统\n\n 本文将指导您在 Linux 服务器上搭建 GitLab，集成 GitBook 并通过 GitLab CI 实现一个企业级或个人 Wiki 系统，实现提交代码时自动刷新部署 GitBook 内容。\n\n## 环境准备\n\n1. 一台 Linux 服务器（推荐 Ubuntu Jammy）\n2. 安装 Node.js 及 npm 环境（推荐 v12.16.3，版本过高可能导致 GitBook 安装报错）\n\n## 安装 Node.js 环境\n\n### 方法一：使用 NVM（推荐）\n\nNVM（Node Version Manager）可以方便地管理多个 Node.js 版本：\n\n`shell\n# 下载并安装 nvm\ncurl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.2/install.sh | bash\n\n# 立即加载 nvm\n\\. \"$HOME/.nvm/nvm.sh\"\n\n# 下载并安装指定版本的 Node.js\nnvm install 12.16.3\n\n# 验证安装\nnode -v\nnpm -v\n`\n\n### 方法二：手动安装\n\n1. 创建并进入 node 目录：\n `shell\n mkdir node\n cd node\n `\n\n2. 下载并解压 Node.js：\n `shell\n wget https://nodejs.org/dist/v12.16.3/node-v12.16.3-linux-x64.tar.xz\n tar xf node-v12.16.3-linux-x64.tar.xz\n `\n\n3. 移动并重命名目录：\n `shell\n mkdir /usr/local/lib/node\n mv node-v12.16.3-linux-x64 /usr/local/lib/node/nodejs\n `\n\n4. 设置环境变量：\n `shell\n sudo vim /etc/profile\n `\n 在文件底部添加：\n `shell\n export NODEJS_HOME=/usr/local/lib/node/nodejs\n export PATH=$NODEJS_HOME/bin:$PATH\n `\n 保存后刷新配置：\n `shell\n source /etc/profile\n `\n\n## 安装 Git\n\n`shell\nsudo apt install git\ngit --version\n`\n\n## 安装 GitLab\n\n1. 添加 GitLab 仓库密钥：\n `shell\n curl -fsSL https://packages.gitlab.com/gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/gitlab_gitlab-ce-archive-keyring.gpg\n `\n\n2. 添加清华镜像源：\n `shell\n echo 'deb [signed-by=/usr/share/keyrings/gitlab_gitlab-ce-archive-keyring.gpg] https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu jammy main' | sudo tee /etc/apt/sources.list.d/gitlab-ce.list\n `\n\n3. 安装 GitLab：\n `shell\n sudo apt-get update\n sudo apt-get install gitlab-ce\n `\n\n4. 配置 GitLab：\n `shell\n sudo vim /etc/gitlab/gitlab.rb\n `\n 修改 `external_url` 为您的服务器地址，例如：\n `shell\n external_url \"http://192.168.0.1:20001\"\n `\n\n5. 重新配置并重启 GitLab：\n `shell\n sudo gitlab-ctl reconfigure\n sudo gitlab-ctl restart\n `\n\n6. 获取初始密码：\n `shell\n sudo cat /etc/gitlab/initial_root_password\n `\n\n## 安装 GitBook\n\n1. 设置 npm 镜像源：\n `shell\n npm config set registry https://registry.npmmirror.com\n `\n\n2. 安装 GitBook CLI：\n `shell\n npm install gitbook-cli -g\n `\n\n## 安装 GitLab Runner\n\n1. 添加 GitLab Runner 仓库密钥：\n `shell\n curl -L https://packages.gitlab.com/runner/gitlab-runner/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/gitlab-runner.gpg\n `\n\n2. 添加清华镜像源：\n `shell\n echo 'deb [signed-by=/usr/share/keyrings/gitlab-runner.gpg] https://mirrors.tuna.tsinghua.edu.cn/gitlab-runner/ubuntu jammy main' | sudo tee /etc/apt/sources.list.d/gitlab-runner.list\n `\n\n3. 安装 GitLab Runner：\n `shell\n sudo apt-get update\n sudo apt-get install gitlab-runner\n sudo chmod +x /usr/local/bin/gitlab-runner\n `\n\n4. 安装并启动 Runner：\n `shell\n sudo gitlab-runner install --user=root\n sudo gitlab-runner start\n `\n\n## 配置 GitLab Runner\n\n1. 注册 Runner：\n `shell\n sudo gitlab-runner register\n `\n 按照提示输入：\n - GitLab 实例 URL\n - 注册令牌（从 GitLab 项目的 Settings > CI/CD > Runners 获取）\n - 描述（如 \"my-runner\"）\n - 标签（如 \"gitbook\"）\n - 执行器（选择 \"shell\"）\n\n2. 验证 Runner 是否注册成功：\n 在 GitLab 项目的 Settings > CI/CD > Runners 中查看 Runner 状态。\n\n## 配置 GitBook 自动化部署\n\n1. 在 GitBook 项目根目录创建 `.gitlab-ci.yml` 文件：\n `yaml\n stages:\n - build\n wiki-deploy:\n tags:\n - gitbook # 与注册 Runner 时设置的标签一致\n stage: build\n script:\n - pwd\n - gitbook install\n - gitbook build\n - setsid nohup sh startup.sh > nohup.out 2>&1 &\n `\n\n2. 创建 `startup.sh` 脚本：\n `` shell\n #!/bin/bash\n for i in `ps -ef | grep gitbook | grep serve`; do kill -9 $i ; done;\n gitbook serve\n  ``\n 并赋予执行权限：\n `shell\n chmod +x startup.sh\n `\n\n## 验证部署\n\n1. 将项目推送到 GitLab 仓库\n2. 在 GitLab 的 CI/CD > Pipelines 中查看构建状态\n3. 访问 `http://服务器IP:4000` 查看实时更新的 Wiki 内容\n\n 至此，您已成功搭建了一个自动化的 Wiki 系统，每次推送代码到 GitLab 都会自动构建并更新 GitBook 内容。
